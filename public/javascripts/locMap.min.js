function $(e){return document.getElementById(e)}function $XMLHttpRequest(e,t,a,n){if(window.XMLHttpRequest)var o=new XMLHttpRequest;else if(window.ActiveXobject)var o=new ActiveXobject("Microft.XMLHttp");o.open(e,t,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),o.send(a),o.onreadystatechange=function(){4==o.readyState&&200==o.status&&n(o.responseText)}}var bmap={status:!1,map:"",point:"",overlaysCache:[],polOverlay:[],myOverlay:[],drawingManager:"",init:function(){if(!this.status){this.status=!0,this.map=new BMap.Map("map"),this.point=new BMap.Point(116.307852,40.057031);var e=this.map,t=new BMap.MapTypeControl;t.setAnchor(BMAP_ANCHOR_TOP_LEFT),e.addControl(t),e.centerAndZoom(this.point,12),e.enableScrollWheelZoom(),this.myOverlay&&this.loadMyOverlay()}},loadMyOverlay:function(){var e=this.map;$XMLHttpRequest("get","/gpsobj/getPolygon",null,function(t){for(var a=[],n=JSON.parse(t),o=JSON.parse(n.result),l=0;l<o.length;l++)a.push(new BMap.Point(o[l].lng,o[l].lat));bmap.polOverlay=new BMap.Polygon(a),bmap.polOverlay.disableMassClear(),e.addOverlay(bmap.polOverlay)})},addInfoWindow:function(e,t,a,n,o){e.addEventListener("click",function(e){var l={width:100,height:50,title:"<div style='font-size:16px;font-family:Arial;color:#8e8e8e'>定位对象名称："+t+"</div>",enableMessage:!0},i=new BMap.InfoWindow("<div style='font-size:16px;font-family:Arial;color:#8e8e8e'>原始坐标:("+a+","+n+")</div>",l);this.openInfoWindow(i,o)})},transCoor:function(e,t){var a=new BMap.Convertor,n=[];n.push(e),a.translate(n,1,5,function(e){0===e.status&&t(e.points[0])})},shiftCoor:function(e,t){(new BMap.Convertor).translate(e,1,5,function(e){0===e.status&&t(e.points)})}};bmap.init();var isPanelShow=!0,showPanel=$("showPanel");showPanel.addEventListener("click",function(){var e=$("panelWrap");isPanelShow?(isPanelShow=!1,e.style.width="230px",showPanel.style.marginRight="230px",showPanel.innerHTML="隐藏定位对象>",$XMLHttpRequest("GET","/gpsobj/getBindobj",null,function(e){$("selObj").options.length=0,$("queryOne").options.length=0;var t=JSON.parse(e),a=t.result;$("selObj").options.add(new Option("请选择需要查询的定位对象","1")),$("queryOne").options.add(new Option("请选择需要查询的定位对象","1"));for(var n=0;n<a.length;n++)$("selObj").options.add(new Option(a[n].alias,a[n].id)),$("queryOne").options.add(new Option(a[n].alias,a[n].id))})):(isPanelShow=!0,e.style.width="0px",showPanel.style.marginRight="0px",showPanel.innerHTML="选取定位对象<")},!1);var timer1local,timer2local;$("queryAll").addEventListener("click",function(e){function t(){var e=bmap.map;e.clearOverlays(),$XMLHttpRequest("post","/gpsobj/getValue",null,function(t){for(var a=JSON.parse(t),n=0;n<a.result.length;n++){var o=a.result[n].lastValue;if(null!=o){var l=(a.result[n].alias,o.substr(0,o.indexOf(","))),i=o.substr(o.indexOf(",")+1,o.length),s=new BMap.Point(l,i);!function(t){var n=l,o=i;bmap.transCoor(s,function(l){var i=new BMap.Marker(l);if(e.addOverlay(i),1==BMapLib.GeoUtils.isPointInPolygon(l,bmap.polOverlay)){var s=new BMap.Label(a.result[t].alias,{offset:new BMap.Size(20,-10)});i.setLabel(s)}else{var s=new BMap.Label(a.result[t].alias+"已超出围栏外",{offset:new BMap.Size(20,-10)});s.setStyle({backgroundColor:"red",color:"black",fontSize:"12px",height:"20px",lineHeight:"20px",fontFamily:"微软雅黑"}),i.setLabel(s)}bmap.addInfoWindow(i,a.result[t].alias,n,o,l)})}(n)}}}),timer1local=setTimeout(t,5e3)}this.disabled="true",this.style.opacity=.5,$("selObj").options[0].selected=!0,$("queryOne").options[0].selected=!0,clearTimeout(timer2local),t()}),$("queryOne").addEventListener("change",function(e){function t(){var e=bmap.map,n="id="+a.value;e.clearOverlays(),$XMLHttpRequest("post","/gpsobj/getValue",n,function(t){var a=JSON.parse(t),n=a.result[0].lastValue;if(null!=n){var o=n.substr(0,n.indexOf(",")),l=n.substr(n.indexOf(",")+1,n.length),i=new BMap.Point(o,l);new BMap.Marker(i);bmap.transCoor(i,function(t){var n=new BMap.Marker(t);e.addOverlay(n),n.setAnimation(BMAP_ANIMATION_BOUNCE);var i=new BMap.Label(a.result[0].alias,{offset:new BMap.Size(20,-10)});n.setLabel(i),bmap.addInfoWindow(n,a.result[0].alias,o,l,t),1==BMapLib.GeoUtils.isPointInPolygon(t,bmap.polOverlay)||(i=new BMap.Label(a.result[0].alias+"已超出围栏外",{offset:new BMap.Size(20,-10)}),i.setStyle({backgroundColor:"red",color:"black",fontSize:"12px",height:"20px",lineHeight:"20px",fontFamily:"微软雅黑"}),n.setLabel(i))})}}),timer2local=setTimeout(t,5e3)}var a=this;$("queryAll").disabled=!1,$("queryAll").style.opacity=1,$("selObj").options[0].selected=!0,clearTimeout(timer1local),clearTimeout(timer2local),t()},!1),$("selObj").addEventListener("change",function(e){$("queryAll").disabled=!1,$("queryAll").style.opacity=1,$("queryOne").options[0].selected=!0,clearTimeout(timer1local),clearTimeout(timer2local);var t="id="+this.value,a=bmap.map;a.clearOverlays();$XMLHttpRequest("post","/gpsobj/getHisdata",t,function(e){for(var t=JSON.parse(e),n=[],o=[],l=t.result[0].gpsobj_id,i=0,s=t.result.length;i<s;i++){var r=t.result[i].coordinate,p=r.substr(0,r.indexOf(",")),u=r.substr(r.indexOf(",")+1,r.length),d=new BMap.Point(p,u);o.push(t.result[i].insertTime),n.push(d)}bmap.shiftCoor(n,function(e){var t=0;for(e.length;t<e.length;t++){var n=new BMap.Marker(e[t]);a.addOverlay(n);var i;if(1==BMapLib.GeoUtils.isPointInPolygon(e[t],bmap.polOverlay)?(i=new BMap.Label(l+"在围栏内",{offset:new BMap.Size(20,-10)}),n.setLabel(i)):(i=new BMap.Label(l+"在围栏外,"+o[t],{offset:new BMap.Size(20,-10)}),i.setStyle({backgroundColor:"red",color:"black",fontSize:"12px",height:"20px",lineHeight:"20px",fontFamily:"微软雅黑"}),n.setLabel(i),n.setAnimation(BMAP_ANIMATION_BOUNCE)),t>=1){var s=new BMap.Polyline([e[t-1],e[t]],{strokeColor:"red",strokeWeight:6,strokeOpacity:.5});a.addOverlay(s)}}})})},!1),$("redraw").addEventListener("click",function(e){window.location.href="./editMap.html"},!1);